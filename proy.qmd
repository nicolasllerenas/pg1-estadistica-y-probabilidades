---
title: "Proyecto"
format:
  html:
    toc: true
    toc-depth: 3
    theme: cosmo
    code-fold: true
    code-summary: "Mostrar / ocultar código"
execute:
  echo: true
  warning: false
  message: false
---

## Introducción

La pandemia por COVID-19 ha tenido un impacto significativo en la salud pública a nivel mundial.\
El análisis de datos epidemiológicos permite comprender mejor las características de los casos y los factores asociados a la gravedad de la enfermedad.

Este informe presenta un análisis descriptivo de los **casos sospechosos y confirmados de COVID-19 en México durante el año 2021**, utilizando una muestra de datos oficiales del sistema de vigilancia epidemiológica.

## Objetivo general

Analizar los casos sospechosos y confirmados de COVID-19 en México durante el año 2021, describiendo sus principales características demográficas y clínicas.

### Objetivos específicos

1.  *Describir la distribución del score de riesgo COVID y del índice de gravedad en los casos sospechosos y confirmados de COVID-19 en México durante el año 2021.*\
    Variables principales: score_riesgo_covid, indice_gravedad\

2.  *Analizar la relación entre el número de comorbilidades y el tipo de atención recibida por los pacientes en los casos sospechosos y confirmados de COVID-19 en México durante el año 2021.*\
    Variables principales: n_comorbilidades, TIPO_PACIENTE\

3.  *Comparar la distribución de los casos según sexo y clasificación final en los casos sospechosos y confirmados de COVID-19 en México durante el año 2021.*\
    Variables principales: SEXO, CLASIFICACION_FINAL\

## Metodología

### Población de estudio

La población está conformada por los registros acumulados en el **Sistema de Vigilancia Epidemiológica de Enfermedades Respiratorias Viral (SISVER)** correspondientes al año 2021.

### Tipo de muestreo

Se utilizó un **muestreo aleatorio simple**, garantizando que cada individuo tuviera la misma probabilidad de ser seleccionado.

### Unidad muestral

La unidad muestral es el **individuo (paciente)**.\
Cada fila del conjunto de datos representa a una persona registrada en una unidad de salud.

## Preparación del entorno

```{r}
#| label: setup
#| include: false

library(dplyr)
library(ggplot2)
library(lubridate)
library(knitr)
```

### Carga de datos

```{r}
DATOS_INICIALES <- read.csv("muestra_covid_500M_NA.csv")
```

#DATOS INICIALES

```{r}
str(DATOS_INICIALES)
```

#LIMPIANDO VARIABLES

## ESTADO

```{r}
DATOS_INICIALES <- DATOS_INICIALES |> 
  mutate(ESTADO = if_else(is.na(FECHA_DEF), "Vivo", "Muerto")) |> 
  select(-FECHA_DEF)
```

##SEXO

```{r}
table(DATOS_INICIALES$SEXO, useNA = "always")
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |> 
  filter(!is.na(SEXO))
```

```{r}
table(DATOS_INICIALES$SEXO, useNA = "always")
```

##EDAD

```{r}
summary(DATOS_INICIALES$EDAD)
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |> 
  mutate(EDAD = ifelse(EDAD == 0 | EDAD > 100, NA, EDAD))
```

```{r}
summary(DATOS_INICIALES$EDAD)
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |> 
  filter(!is.na(EDAD))
```

```{r}
summary(DATOS_INICIALES$EDAD)
```

## Dias_retraso

```{r}
library(lubridate)
DATOS_INICIALES <- DATOS_INICIALES |> 
  mutate(
    FECHA_INGRESO = as.Date(FECHA_INGRESO, format = "%Y-%m-%d"),
    FECHA_SINTOMAS = as.Date(FECHA_SINTOMAS, format = "%Y-%m-%d"),
    DIAS_RETRASO = as.numeric(FECHA_INGRESO - FECHA_SINTOMAS),
    DIAS_RETRASO = if_else(DIAS_RETRASO < 0, NA_real_, DIAS_RETRASO)
  )
  
```

```{r}
summary(DATOS_INICIALES$DIAS_RETRASO)
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |> 
  filter(!is.na(DIAS_RETRASO))
```

```{r}
summary(DATOS_INICIALES$DIAS_RETRASO)
```

## N_COMORBILIDADES

```{r}
DATOS_INICIALES <- DATOS_INICIALES |>
  mutate(
    N_COMORBILIDADES = rowSums(
      across(
        c(
          DIABETES,
          EPOC,
          ASMA,
          INMUSUPR,
          HIPERTENSION,
          CARDIOVASCULAR,
          OBESIDAD,
          RENAL_CRONICA,
          TABAQUISMO,
          OTRA_COM
        ),
        ~ ifelse(.x == 1, 1, 0)
      ),
      na.rm = TRUE
    )
  )

```

```{r}
summary(DATOS_INICIALES$N_COMORBILIDADES)
```

##SORE_RIESGO_COVID

```{r}
table(DATOS_INICIALES$RESULTADO_LAB, useNA = "always")
table(DATOS_INICIALES$RESULTADO_ANTIGENO, useNA = "always")
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |>
  mutate(
    CARGA_ENFERMEDAD = N_COMORBILIDADES / 10,
    FACTOR_CERTEZA = case_when(
        RESULTADO_LAB == 1 | RESULTADO_ANTIGENO == 1 ~ 3,  
        RESULTADO_LAB == 2 | RESULTADO_ANTIGENO == 2 ~ 1,  
        TRUE ~ 2                                           
      ),
    SCORE_RIESGO_COVID = CARGA_ENFERMEDAD * FACTOR_CERTEZA
  )

```

```{r}
summary(DATOS_INICIALES$CARGA_ENFERMEDAD)
summary(DATOS_INICIALES$FACTOR_CERTEZA)
summary(DATOS_INICIALES$SCORE_RIESGO_COVID)
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |>
  mutate(
    CARGA_ENFERMEDAD = ifelse(CARGA_ENFERMEDAD < 0 | CARGA_ENFERMEDAD > 1, NA, CARGA_ENFERMEDAD),
    SCORE_RIESGO_COVID = ifelse(SCORE_RIESGO_COVID < 0 | SCORE_RIESGO_COVID > 3, NA, SCORE_RIESGO_COVID)
  )
```

```{r}
summary(DATOS_INICIALES$SCORE_RIESGO_COVID)
```

```{r}
summary(DATOS_INICIALES$SCORE_RIESGO_COVID)
```

## INDICE_GRAVEDAD

```{r}
table(DATOS_INICIALES$NEUMONIA, useNA = "always")
table(DATOS_INICIALES$UCI, useNA = "always")
table(DATOS_INICIALES$INTUBADO, useNA = "always")
table(DATOS_INICIALES$ESTADO, useNA = "always")
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |>
  mutate(
    NEUMONIA01 = case_when(
      NEUMONIA == 1 ~ 1,
      NEUMONIA == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    UCI01 = case_when(
      UCI == 1 ~ 1,
      UCI == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    INTUBADO01 = case_when(
      INTUBADO == 1 ~ 1,
      INTUBADO == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    DEFUNCION01 = case_when(
      ESTADO == "Muerto" ~ 1,
      ESTADO == "Vivo" ~ 0,
      TRUE ~ NA_real_
    ),
    INDICE_GRAVEDAD = (1*NEUMONIA01 + 2*UCI01 + 3*INTUBADO01 + 4*DEFUNCION01) / 10
  )

```

```{r}
summary(DATOS_INICIALES$INDICE_GRAVEDAD)
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |>
  filter(!is.na(INDICE_GRAVEDAD))

```

```{r}
range(DATOS_INICIALES$INDICE_GRAVEDAD, na.rm = TRUE)
```

```{r}
DATOS_INICIALES |> 
  filter(INDICE_GRAVEDAD < 0 | INDICE_GRAVEDAD > 1) %>%
  nrow()
```

```{r}
summary(DATOS_INICIALES$INDICE_GRAVEDAD)
```

## ENTIDAD_RES

```{r}
table(DATOS_INICIALES$ENTIDAD_RES, useNA = "always")
sum(is.na(DATOS_INICIALES$ENTIDAD_RES))
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |>
  mutate(
    ENTIDAD_RES = na_if(trimws(as.character(ENTIDAD_RES)), ""),
    ENTIDAD_RES = suppressWarnings(as.integer(ENTIDAD_RES)),
    ENTIDAD_RES = ifelse(ENTIDAD_RES %in% 1:32, ENTIDAD_RES, NA_integer_)
  ) |>
  filter(!is.na(ENTIDAD_RES))
```

```{r}
table(DATOS_INICIALES$ENTIDAD_RES, useNA = "always")
```

##N_COMPLICACIONES_GRAVES

```{r}
summary(DATOS_INICIALES$NEUMONIA)
summary(DATOS_INICIALES$INTUBADO)
summary(DATOS_INICIALES$UCI)
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |>
  mutate(
    N_COMPLICACIONES_GRAVES =
      (NEUMONIA == 1) + (INTUBADO == 1) + (UCI == 1)
  )
```

```{r}
summary(DATOS_INICIALES$N_COMPLICACIONES_GRAVES)
table(DATOS_INICIALES$N_COMPLICACIONES_GRAVES, useNA = "always")
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |>
  mutate(
    N_COMPLICACIONES_GRAVES = ifelse(N_COMPLICACIONES_GRAVES %in% 0:3,
                                     N_COMPLICACIONES_GRAVES, NA)
  ) |>
  filter(!is.na(N_COMPLICACIONES_GRAVES))
```

```{r}
table(DATOS_INICIALES$N_COMPLICACIONES_GRAVES, useNA = "always")
```

## TIPO_PACIENTE

```{r}
table(DATOS_INICIALES$TIPO_PACIENTE, useNA = "always")
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |> 
  filter(!is.na(TIPO_PACIENTE))
```

```{r}
table(DATOS_INICIALES$TIPO_PACIENTE, useNA = "always")
```

## CLASIFICACION_FINAL

```{r}
table(DATOS_INICIALES$CLASIFICACION_FINAL, useNA = "always")
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |> 
  mutate(CLASIFICACION_FINAL = ifelse(CLASIFICACION_FINAL == 7, NA, CLASIFICACION_FINAL))
```

```{r}
DATOS_INICIALES <- DATOS_INICIALES |> 
  filter(!is.na(CLASIFICACION_FINAL))
```

```{r}
table(DATOS_INICIALES$CLASIFICACION_FINAL, useNA = "always")
```

## Variables seleccionadas para el análisis

| \# | Variable | Tipo estadístico | Origen / Cómo se obtiene | Justificación breve |
|-------|---------------|---------------|---------------|---------------|
| 1 | EDAD | Cuantitativa discreta | Columna original | Edad en años completos, permite media, desviación estándar, correlaciones, etc. |
| 2 | dias_retraso | Cuantitativa discreta | Derivada: FECHA_INGRESO - FECHA_SINTOMAS | Tiempo en días (puede tener decimales si usas unidades="days"), continua clásica |
| 3 | n_comorbilidades | Cuantitativa discreta | Derivada: suma de 10 comorbilidades (solo 1=Sí) | Conteo entero (0 a 10), discreta por naturaleza |
| 4 | n_complicaciones_graves | Cuantitativa discreta | Derivada: suma de NEUMONIA + INTUBADO + UCI (solo 1=Sí) | Conteo entero (0 a 3), discreta, indica severidad |
| 5 | SEXO | Cualitativa nominal | Columna original | Categorías sin orden: Mujer / Hombre / No especificado |
| 6 | ENTIDAD_RES | Cualitativa nominal | Columna original | 32 entidades federativas + posible 99, sin orden jerárquico |
| 7 | TIPO_PACIENTE | Cualitativa ordinal | Columna original | 1 = Ambulatorio \< 2 = Hospitalizado (orden lógico de gravedad) |
| 8 | CLASIFICACION_FINAL | Cualitativa ordinal | Columna original | Niveles con jerarquía de certeza/severidad (Confirmado \> Sospechoso \> otros) |

### Objetivos específicos

1.  **Describir la distribución de la edad y el tiempo de retraso entre el inicio de síntomas y el ingreso hospitalario en los casos sospechosos y confirmados de COVID-19 en México durante el año 2021.**\
    Variables principales: EDAD, dias_retraso, CLASIFICACION_FINAL\
    Métodos sugeridos: estadísticos descriptivos (media, mediana, percentiles), histogramas, boxplots, tablas resumen.

2.  **Analizar la relación entre el número de comorbilidades y el número de complicaciones graves con el tipo de atención requerida en los casos sospechosos y confirmados de COVID-19 en México durante el año 2021.**\
    Variables principales: n_comorbilidades, n_complicaciones_graves, TIPO_PACIENTE\
    Métodos sugeridos: tablas cruzadas, porcentajes, gráficos de barras apiladas, prueba chi-cuadrado o correlación de Spearman.

3.  **Comparar la distribución por sexo y entidad de residencia entre los casos sospechosos y confirmados de COVID-19 en México durante el año 2021.**\
    Variables principales: SEXO, ENTIDAD_RES, CLASIFICACION_FINAL\
    Métodos sugeridos: tablas de contingencia, gráficos de barras apiladas o mosaico, prueba de independencia chi-cuadrado.#Objetivos especificos

```{r}
#| label: analisis-edad

# Tabla descriptiva de EDAD
tabla_edad <- datos_limpios %>%
  group_by(CLASIFICACION_FINAL) %>%
  summarise(
    Casos = n(),
    Media = round(mean(EDAD, na.rm = TRUE), 2),
    Mediana = median(EDAD, na.rm = TRUE),
    Desv.Std = round(sd(EDAD, na.rm = TRUE), 2),
    Min = min(EDAD, na.rm = TRUE),
    Max = max(EDAD, na.rm = TRUE)
  )

# Imprimimos tabla
knitr::kable(tabla_edad, caption = "Estadísticos descriptivos de EDAD por Clasificación")
```

```{r}
#| label: graficos-edad
#| fig.width: 10
#| fig.height: 8

# Histograma General con curva de densidad
p1 <- ggplot(datos_limpios, aes(x = EDAD)) +
  geom_histogram(aes(y = ..density..), binwidth = 5, fill = "#69b3a2", color = "white", alpha=0.8) +
  geom_density(alpha = 0.2, fill = "#FF6666") +
  theme_minimal() +
  labs(title = "A) Distribución General de la Edad",
       subtitle = "Histograma con curva de densidad",
       x = "Edad (años)", y = "Densidad")

# Boxplot por Clasificación para comparar grupos
p2 <- ggplot(datos_limpios, aes(x = CLASIFICACION_FINAL, y = EDAD, fill = CLASIFICACION_FINAL)) +
  geom_boxplot(alpha = 0.6, outlier.size = 0.5, outlier.alpha = 0.3) +
  theme_minimal() +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  labs(title = "B) Comparación de Edad por Clasificación",
       subtitle = "Diagrama de Caja y Bigotes",
       x = "Clasificación", y = "Edad (años)")


p1
p2
```
